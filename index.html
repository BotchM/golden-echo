<!doctype html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="./styles/main.css">
  </head>
  <body>
    <div class="script">
      <script src="./third-party/jquery.js"></script>
      <script src="./third-party/noise.js"></script>
      <script src="./third-party/two.js"></script>
      <script src="./src/spark.js"></script>
      <script src="./src/tomahawk.js"></script>
      <script>

        var two = new Two({
          type: Two.Types.canvas,
          fullscreen: true,
          autostart: true
        }).appendTo(document.body);

        noise.seed(Math.random());

        var purple = { r: 33, g: 33, b: 33 }, orange = { r: 45, g: 45, b: 45 };
        var drag = 0.0625;

        var colors = [purple, orange];
        var timeElapsed = 0;

        var background = two.makeRectangle(two.width / 2, two.height / 2, two.width, two.height);
        background.color = _.clone(purple);
        background.dest = orange;

        background.color.toString = function() {
          return 'rgb(' +
            Math.floor(background.color.r) + ',' +
            Math.floor(background.color.g) + ',' +
            Math.floor(background.color.b) + ')';
        };

        background.noStroke().fill = background.color.toString();

        var amount = 15;

        var noiseStrength = 20;
        var noiseScale = 300;
        var step = 5;
        var agent = new Two.Vector();

        var sparks = _.map(_.range(amount), function(i) {

          var startAngle = Math.random() * Math.PI * 2;
          var endAngle = Math.random() * (Math.PI * 2 - startAngle) + startAngle;

          var spark = new Spark({
            amount: Math.floor(Math.random() * 30) + 1,
            radius: Math.random() * 14 + 1,
            linewidth: Math.random() * 5
          }).addTo(two);

          spark.step = Math.random() * step;
          spark.translation.set(Math.random() * two.width, Math.random() * two.height);
          spark.scale = Math.random() * 2 + 1;
          spark.opacity = 0;

          return spark;

        });

        var tomahawk = new Tomahawk(two);
        tomahawk.translation.set(two.width / 2, two.height / 2);
        tomahawk.ready(function() {
          tomahawk.shape.opacity = 0.50;
          tomahawk.shape.fill = 'white';
          tomahawk.shape.stroke = 'white';//rgb(255, 75, 75)';
          tomahawk.shape.linewidth = 10;
          tomahawk.shape.join = 'round';
        });

        window.addEventListener('click', function(e) {

          tomahawk.explode({ x: e.clientX, y: e.clientY }, 200 * Math.random());

          // for (var i = 0, l = sparks.length; i < l; i++) {

          //   var spark = sparks[i];

          //   if (spark.visible) {
          //     continue;
          //   }

          //   var x = e.clientX + Math.random() * 100 - 50;
          //   var y = e.clientY + Math.random() * 100 - 50;

          //   spark.visible = true;
          //   spark.opacity = 0;
          //   spark.translation.set(x, y);

          // }

        });

        two
          .bind('resize', function() {

            var w = two.width / 2;
            var h = two.height / 2;

            background.translation.set(w, h);
            background.vertices[0].set(- w, - h);
            background.vertices[1].set(w, - h);
            background.vertices[2].set(w, h);
            background.vertices[3].set(- w, h);

          })
          .bind('update', function(frameCount, timeDelta) {

            if (!timeDelta) {
              return;
            }

            tomahawk.update();

            for (var i = 0, l = sparks.length; i < l; i++) {

              var spark = sparks[i];

              if (!spark.visible) {
                continue;
              }

              var angle = noise.perlin2(spark.translation.x / noiseScale, spark.translation.y / noiseScale) * noiseStrength;
              agent.set(spark.step * Math.cos(angle), spark.step * Math.sin(angle));
              spark.translation.addSelf(agent);

              var x = spark.translation.x;
              var y = spark.translation.y;

              if (x < - spark.radius || x > two.width + spark.radius ||
                y < - spark.radius || y > two.height + spark.radius) {
                spark.translation.set(
                  Math.random() * two.width,
                  Math.random() * two.height
                );
                // spark.visible = false;
                spark.opacity = 0;
              }

              spark.update();
              spark.opacity += (0.33 - spark.opacity) * 0.0625;

            }

            if (timeElapsed > 2000) {
              background.dest = colors[Math.floor(Math.random() * colors.length)];
              timeElapsed = 0;
            }

            background.color.r += (background.dest.r - background.color.r) * drag;
            background.color.g += (background.dest.g - background.color.g) * drag;
            background.color.b += (background.dest.b - background.color.b) * drag;

            background.noStroke().fill = background.color.toString();
            timeElapsed += timeDelta;

          });

      </script>
    </div>
  </body>
</html>